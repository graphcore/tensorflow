load("//tensorflow/compiler/plugin/poplar:poplar.bzl", "poplar_cc_library")
load("//tensorflow/core/platform:build_config.bzl", "tf_proto_library")

licenses(["restricted"])

package(default_visibility = ["//tensorflow/compiler/plugin/poplar:__subpackages__"])

tf_proto_library(
    name = "ops_proto",
    srcs = [
        "ops.proto",
    ],
    cc_api_version = 2,
    j2objc_api_version = 1,
    make_default_target_header_only = True,
)

tf_proto_library(
    name = "popfloat_config_protos",
    srcs = ["popfloat/gfloat_config_utils.proto"],
    cc_api_version = 2,
    j2objc_api_version = 1,
    make_default_target_header_only = True,
)

poplar_cc_library(
    name = "custom_kernels_util",
    srcs = [
        "custom_kernels_util.cc",
    ],
    hdrs = [
        "custom_kernels_util.h",
        "//tensorflow/compiler/plugin/poplar/driver/tools:util.h",
    ],
    deps = [
        ":ops_proto_cc",
        "//tensorflow/compiler/plugin/poplar/driver:backend_config_proto_cc_impl",
        "//tensorflow/compiler/plugin/poplar/driver:config_proto_cc_impl",
        "//tensorflow/compiler/plugin/poplar/driver:option_flag_proto_cc_impl",
        "//tensorflow/compiler/plugin/poplar/driver:threestate_proto_cc_impl",
        "//tensorflow/compiler/plugin/poplar/driver/tools:alias_info_proto_cc_impl",
        "//tensorflow/compiler/plugin/poplar/driver/tools:flags",
        "//tensorflow/compiler/xla:xla_headers_lib",
        "//tensorflow/compiler/xla/service:hlo",
        "//third_party/eigen3",
        "@com_google_absl//absl/strings",
        "@com_google_absl//absl/types:any",
        "@com_google_absl//absl/types:bad_any_cast",
        "@com_google_protobuf//:protobuf_headers",
        "@jsoncpp_git//:jsoncpp",
    ],
    alwayslink = True,
)

poplar_cc_library(
    name = "embedded_runtime_kernels",
    srcs = [
        "application_runtime/application_compile.cc",
        "application_runtime/application_runtime.cc",
        "application_runtime/resource_handle_pruner.cc",
    ],
    hdrs = [
        "application_runtime/resource_handle_pruner.h",
        "functional/functional_util.h",
        "ipu_kernels_common.h",
    ],
    visibility = ["//visibility:public"],
    deps = [
        "//tensorflow/compiler/jit/kernels:xla_ops",
        "//tensorflow/compiler/plugin/poplar/driver:ipu_devices",
        "//tensorflow/compiler/plugin/poplar/driver:poplar_executor",
        "//tensorflow/compiler/plugin/poplar/driver:poplar_platform",
        "//tensorflow/compiler/plugin/poplar/driver/tools:poplar_executable_binary_file",
        "//tensorflow/compiler/plugin/poplar/driver/tools:tracepoint",
        "@local_config_poplar//poplar:poplar_libs",
    ],
    alwayslink = True,
)

poplar_cc_library(
    name = "kernels",
    srcs = [
        "datastream/dataset_benchmark.cc",
        "datastream/exporters.cc",
        "datastream/feeds.cc",
        "datastream/host_embedding.cc",
        "functional/functional.cc",
        "functional/functional_util.cc",
        "functional/pipelining.cc",
        "host_compute_kernels.cc",
        "ipu_kernels.cc",
        "popfloat/cast_to_gfloat.cc",
        "popnn/arg_min_max.cc",
        "popnn/ctc_loss.cc",
        "popnn/gru.cc",
        "popnn/lstm.cc",
        "popnn/non_linearity.cc",
        "popnn/norm.cc",
        "popnn/onehot.cc",
        "popnn/pooling.cc",
        "popnn/topk.cc",
        "popops/all_reduce.cc",
        "popops/all_to_all.cc",
        "popops/erf.cc",
        "popops/histogram.cc",
        "popops/multi_slice.cc",
        "popops/normalise_image.cc",
        "popops/reduce_scatter.cc",
        "popops/sequence_slice.cc",
        "popops/sparse_softmax_cross_entropy.cc",
        "popops/within_replicas.cc",
        "poprand/candidate_sampler.cc",
        "poprand/categorical.cc",
        "poprand/dropout_xla.cc",
        "poprand/random.cc",
        "poprand/random_ops.cc",
        "poputil/assert.cc",
        "poputil/assume_equal_across_replicas.cc",
        "poputil/barrier.cc",
        "poputil/codelet_expression.cc",
        "poputil/device_sync.cc",
        "poputil/execution_counter.cc",
        "poputil/fifo.cc",
        "poputil/print_tensor.cc",
        "poputil/recompute.cc",
        "poputil/remap.cc",
        "poputil/replication_factor.cc",
        "poputil/replication_index.cc",
        "poputil/stateful_gradient_accumulate.cc",
        "poputil/user_operation.cc",
        "sendrecv_kernels.cc",
        "shape_op.cc",
        "training_ops.cc",
    ],
    hdrs = [
        "application_runtime/resource_handle_pruner.h",
        "functional/functional_util.h",
        "ipu_kernels_common.h",
    ],
    deps = [
        ":custom_kernels_util",
        ":embedded_runtime_kernels",
        "//tensorflow/compiler/jit:xla_device",
        "//tensorflow/compiler/jit/kernels:xla_ops",
        "//tensorflow/compiler/plugin/poplar/driver",
        "//tensorflow/compiler/plugin/poplar/driver/tools:attributes_utils",
        "//tensorflow/compiler/plugin/poplar/driver/tools:xla_util",
        "//tensorflow/compiler/plugin/poplar/kernels/dataset:kernels",
        "//tensorflow/compiler/tf2xla:common",
        "//tensorflow/compiler/tf2xla:xla_compiler",
        "//tensorflow/compiler/tf2xla/kernels:tensor_list_utils",
        "//tensorflow/compiler/tf2xla/kernels:xla_ops",
        "//tensorflow/compiler/xla/client/lib:pooling",
        "//tensorflow/compiler/xla/client/lib:prng",
        "//tensorflow/compiler/xla/client/lib:sorting",
        "//tensorflow/core:framework_headers_lib",
        "//tensorflow/core/kernels/data:dataset_utils",
        "//third_party/eigen3",
        "@com_google_protobuf//:protobuf_headers",
        "@jsoncpp_git//:jsoncpp",
    ],
    alwayslink = True,
)
